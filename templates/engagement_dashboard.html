{% extends "base.html" %}
{% set hide_topbar = True %}
{% block title %}Engagement · {{ engagement.name }}{% endblock %}

{% block content %}
<style>
  /* Tailwind-inspired utilities */
  .gradient-bg {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
  }
  
  /* Modern KPI Cards */
  .kpi-card {
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 12px;
    background: white;
  }
  
  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    transition: height 0.3s ease;
  }
  
  .kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15) !important;
  }
  
  .kpi-card:hover::before {
    height: 6px;
  }
  
  /* Color scheme for different stages - Professional Corporate Palette */
  .kpi-card.applications::before { background: linear-gradient(90deg, #64748b, #475569); }
  .kpi-card.shortlist::before { background: linear-gradient(90deg, #3b82f6, #2563eb); }
  .kpi-card.interview-sched::before { background: linear-gradient(90deg, #0ea5e9, #0284c7); }
  .kpi-card.interview-done::before { background: linear-gradient(90deg, #06b6d4, #0891b2); }
  .kpi-card.vetting::before { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
  .kpi-card.contract-issued::before { background: linear-gradient(90deg, #10b981, #059669); }
  .kpi-card.contract-signed::before { background: linear-gradient(90deg, #059669, #047857); }
  
  .kpi-card-body {
    padding: 1.25rem 1rem;
  }
  
  .kpi-icon-wrapper {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.75rem;
    font-size: 1.5rem;
  }
  
  .kpi-card.applications .kpi-icon-wrapper { background: #e2e8f0; color: #475569; }
  .kpi-card.shortlist .kpi-icon-wrapper { background: #dbeafe; color: #2563eb; }
  .kpi-card.interview-sched .kpi-icon-wrapper { background: #e0f2fe; color: #0284c7; }
  .kpi-card.interview-done .kpi-icon-wrapper { background: #cffafe; color: #0891b2; }
  .kpi-card.vetting .kpi-icon-wrapper { background: #ede9fe; color: #7c3aed; }
  .kpi-card.contract-issued .kpi-icon-wrapper { background: #d1fae5; color: #059669; }
  .kpi-card.contract-signed .kpi-icon-wrapper { background: #a7f3d0; color: #047857; }
  
  .kpi-value {
    font-size: clamp(2rem, 4vw, 2.5rem);
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #1f2937 0%, #4b5563 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .kpi-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6b7280;
    line-height: 1.3;
    min-height: 2.6em;
  }
  
  .kpi-grid {
    display: grid;
    gap: 1.25rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  
  @media (min-width: 576px) { .kpi-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
  @media (min-width: 992px) { .kpi-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
  @media (min-width: 1200px) { .kpi-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); } }
  
  /* Modern Card Styles */
  .modern-card {
    border-radius: 16px;
    border: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: box-shadow 0.3s ease;
  }
  
  .modern-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }
  
  /* Header Section */
  .page-header {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    border-radius: 16px;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  
  .page-header h2 {
    color: white;
    margin-bottom: 0.5rem;
  }
  
  .page-header .badge {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-weight: 600;
    padding: 0.35rem 0.75rem;
    backdrop-filter: blur(10px);
  }
  
  .page-header .info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.95);
  }
  
  .page-header .info-item i {
    opacity: 0.8;
  }
  
  /* Progress Bar */
  .progress-modern {
    height: 12px;
    border-radius: 8px;
    background: #e5e7eb;
    overflow: hidden;
  }
  
  .progress-modern .progress-bar {
    background: linear-gradient(90deg, #059669, #047857);
    border-radius: 8px;
    transition: width 0.6s ease;
  }
  
  .progress-stats {
    display: flex;
    align-items: center;
    gap: 2rem;
  }
  
  .progress-stat-item {
    display: flex;
    flex-direction: column;
  }
  
  .progress-stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .progress-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
  }
  
  /* Table Improvements */
  .modern-table {
    font-size: 0.9rem;
  }
  
  .modern-table thead th {
    background: #f9fafb;
    color: #374151;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    padding: 1rem 0.75rem;
    border: none;
  }
  
  .modern-table tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s ease;
  }
  
  .modern-table tbody tr:hover {
    background: #f9fafb;
  }
  
  .modern-table tbody td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
    border: none;
  }
  
  .modern-table .totals-row {
    background: linear-gradient(90deg, #f9fafb, #f3f4f6);
    font-weight: 700;
    border-top: 2px solid #e5e7eb;
  }
  
  /* Mini Progress Bars in Table */
  .mini-progress {
    height: 4px;
    width: 60px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
    display: inline-block;
    margin-left: 0.5rem;
    vertical-align: middle;
  }
  
  .mini-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #059669, #047857);
    border-radius: 2px;
    transition: width 0.3s ease;
  }
  
  /* Status Badges */
  .status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  
  .status-badge.active {
    background: #dcfce7;
    color: #166534;
  }
  
  .status-badge.open {
    background: #dbeafe;
    color: #1e40af;
  }
  
  .status-badge.default {
    background: #f3f4f6;
    color: #6b7280;
  }
  
  /* Action Buttons */
  .btn-modern {
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    transition: all 0.2s ease;
    border: none;
  }
  
  .btn-modern-primary {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
  }
  
  .btn-modern-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    color: white;
  }
  
  .btn-modern-outline {
    background: white;
    border: 2px solid #e5e7eb;
    color: #374151;
  }
  
  .btn-modern-outline:hover {
    border-color: #3b82f6;
    color: #3b82f6;
    background: #f9fafb;
  }
  
  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border-radius: 12px;
    border: 2px dashed #d1d5db;
  }
  
  .empty-state-icon {
    font-size: 3rem;
    color: #d1d5db;
    margin-bottom: 1rem;
  }
  
  .empty-state-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #374151;
    margin-bottom: 0.5rem;
  }
  
  .empty-state-text {
    color: #6b7280;
    margin-bottom: 1.5rem;
  }
  
  /* Jobs Table */
  .jobs-table tbody tr {
    cursor: pointer;
  }
  
  .metric-badge {
    background: #f3f4f6;
    color: #374151;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.875rem;
  }
  
  /* Section Headers */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }
  
  .section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .section-title i {
    color: #3b82f6;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .page-header {
      padding: 1.5rem;
    }
    
    .kpi-card-body {
      padding: 1rem 0.75rem;
    }
    
    .kpi-icon-wrapper {
      width: 40px;
      height: 40px;
      font-size: 1.25rem;
    }
    
    .kpi-value {
      font-size: 1.75rem;
    }
  }
  
  /* Animation for load */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .fade-in-up {
    animation: fadeInUp 0.5s ease forwards;
  }
  
  .stagger-1 { animation-delay: 0.1s; opacity: 0; }
  .stagger-2 { animation-delay: 0.2s; opacity: 0; }
  .stagger-3 { animation-delay: 0.3s; opacity: 0; }
  .stagger-4 { animation-delay: 0.4s; opacity: 0; }
</style>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="container-xxl px-4 pt-3 pb-4">
  <!-- Enhanced Header -->
  <div class="page-header fade-in-up stagger-1">
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-3">
      <div>
        <h2 class="fw-bold mb-2">
          {{ engagement.name }}
          {% if engagement.ref %}
            <span class="badge ms-2">{{ engagement.ref }}</span>
          {% endif %}
        </h2>
        <div class="d-flex flex-wrap gap-3">
          <div class="info-item">
            <i class="fas fa-building"></i>
            <span><strong>{{ engagement.client or "—" }}</strong></span>
          </div>
          <div class="info-item">
            <i class="fas fa-circle-check"></i>
            <span>Status: <strong>{{ engagement.status or '—' }}</strong></span>
          </div>
        </div>
      </div>
      
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-modern-outline btn-sm" href="{{ url_for('engagement_plan', eng_id=engagement.id) }}">
          <i class="fas fa-sliders"></i> Edit Plan
        </a>
        <a class="btn btn-modern-outline btn-sm" href="{{ url_for('engagement_financials', eng_id=engagement.id) }}">
          <i class="fas fa-coins"></i> Financials
        </a>
        <button class="btn btn-modern-outline btn-sm" id="btn-copy-link" data-link="{{ request.url }}">
          <i class="fas fa-share-nodes"></i> Share
        </button>
        <a class="btn btn-modern-outline btn-sm" href="{{ url_for('engagements') }}">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      </div>
    </div>
  </div>

  <!-- KPI Cards Grid -->
  <div class="kpi-grid mb-4 fade-in-up stagger-2">
    <!-- Applications Pending Review -->
    <a class="kpi-card applications shadow-sm text-decoration-none" 
       href="{{ url_for('applications_for_engagement', eng_id=engagement.id) }}">
      <div class="kpi-card-body">
        <div class="kpi-icon-wrapper">
          <i class="fas fa-inbox"></i>
        </div>
        <div class="kpi-value">{{ totals_row.declared }}</div>
        <div class="kpi-label">Applications Pending Review</div>
      </div>
    </a>

    <!-- Shortlist -->
    <a class="kpi-card shortlist shadow-sm text-decoration-none"
       href="{{ url_for('applications_for_engagement', eng_id=engagement.id) }}?filter=shortlisted">
      <div class="kpi-card-body">
        <div class="kpi-icon-wrapper">
          <i class="fas fa-star"></i>
        </div>
        <div class="kpi-value">{{ tile_shortlist }}</div>
        <div class="kpi-label">Shortlist</div>
      </div>
    </a>

    <!-- Interview Scheduled -->
    <a class="kpi-card interview-sched shadow-sm text-decoration-none"
       href="{{ url_for('applications_for_engagement', eng_id=engagement.id) }}?filter=interview_sched">
      <div class="kpi-card-body">
        <div class="kpi-icon-wrapper">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="kpi-value">{{ tile_interview_sched }}</div>
        <div class="kpi-label">Interview Scheduled</div>
      </div>
    </a>

    <!-- Interview Completed -->
    <a class="kpi-card interview-done shadow-sm text-decoration-none"
       href="{{ url_for('applications_for_engagement', eng_id=engagement.id) }}?filter=interview_done">
      <div class="kpi-card-body">
        <div class="kpi-icon-wrapper">
          <i class="fas fa-comments"></i>
        </div>
        <div class="kpi-value">{{ tile_interview_done }}</div>
        <div class="kpi-label">Interview Completed</div>
      </div>
    </a>

    <!-- Vetting in-flight -->
    <a class="kpi-card vetting shadow-sm text-decoration-none"
       href="{{ url_for('applications_for_engagement', eng_id=engagement.id) }}?filter=vetting">
      <div class="kpi-card-body">
        <div class="kpi-icon-wrapper">
          <i class="fas fa-shield-halved"></i>
        </div>
        <div class="kpi-value">{{ tile_vetting }}</div>
        <div class="kpi-label">Vetting In-Flight</div>
      </div>
    </a>

    <!-- Contract Issued -->
    <a class="kpi-card contract-issued shadow-sm text-decoration-none"
       href="{{ url_for('applications_for_engagement', eng_id=engagement.id) }}?filter=issued">
      <div class="kpi-card-body">
        <div class="kpi-icon-wrapper">
          <i class="fas fa-file-contract"></i>
        </div>
        <div class="kpi-value">{{ tile_contract_issued }}</div>
        <div class="kpi-label">Contract Issued</div>
      </div>
    </a>

    <!-- Contract Signed -->
    <a class="kpi-card contract-signed shadow-sm text-decoration-none"
       href="{{ url_for('applications_for_engagement', eng_id=engagement.id) }}?filter=signed">
      <div class="kpi-card-body">
        <div class="kpi-icon-wrapper">
          <i class="fas fa-circle-check"></i>
        </div>
        <div class="kpi-value">{{ tile_contract_signed }}</div>
        <div class="kpi-label">Contract Signed</div>
      </div>
    </a>
  </div>

  <!-- Overall Progress -->
  <div class="modern-card mb-4 fade-in-up stagger-3">
    <div class="card-body p-4">
      <div class="section-header mb-3">
        <div class="section-title">
          <i class="fas fa-chart-line"></i>
          Overall Progress
        </div>
      </div>
      
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-4">
        <div class="progress-stats">
          <div class="progress-stat-item">
            <div class="progress-stat-label">Progress</div>
            <div class="progress-stat-value">{{ progress_pct }}%</div>
          </div>
          <div class="progress-stat-item">
            <div class="progress-stat-label">Signed</div>
            <div class="progress-stat-value">{{ totals_row.signed }}</div>
          </div>
          <div class="progress-stat-item">
            <div class="progress-stat-label">Planned</div>
            <div class="progress-stat-value">{{ planned_by_role.values()|sum }}</div>
          </div>
        </div>
        
        <div class="flex-grow-1" style="min-width: 200px; max-width: 500px;">
          <div class="progress-modern">
            <div class="progress-bar" role="progressbar" 
                 style="width: {{ progress_pct }}%;" 
                 aria-valuenow="{{ progress_pct }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Per-Role Delivery -->
  <div class="modern-card mb-4 fade-in-up stagger-4">
    <div class="card-body p-4">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-users-gear"></i>
          Per-Role Delivery
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table modern-table mb-0">
          <thead>
            <tr>
              <th>Role</th>
              <th class="text-center">Planned</th>
              <th class="text-center">Declared</th>
              <th class="text-center">Interview Sched</th>
              <th class="text-center">Interview Done</th>
              <th class="text-center">Vetting</th>
              <th class="text-center">Contract Issued</th>
              <th class="text-center">Signed</th>
              <th class="text-center">Progress</th>
            </tr>
          </thead>
          <tbody>
            {% for role in display_roles %}
              {% set m = role_metrics.get(role, {}) %}
              {% set planned = m.get('planned', 0) %}
              {% set signed = m.get('signed', 0) %}
              {% set role_progress = (signed * 100 / planned)|int if planned > 0 else 0 %}
              <tr>
                <td><strong>{{ role }}</strong></td>
                <td class="text-center">{{ planned }}</td>
                <td class="text-center">{{ m.get('declared', 0) }}</td>
                <td class="text-center">{{ m.get('sched', 0) }}</td>
                <td class="text-center">{{ m.get('done', 0) }}</td>
                <td class="text-center">{{ m.get('vetting', 0) }}</td>
                <td class="text-center">{{ m.get('issued', 0) }}</td>
                <td class="text-center">{{ signed }}</td>
                <td class="text-center">
                  <span class="metric-badge">{{ role_progress }}%</span>
                  <div class="mini-progress">
                    <div class="mini-progress-bar" style="width: {{ role_progress }}%"></div>
                  </div>
                </td>
              </tr>
            {% endfor %}
            <tr class="totals-row">
              <td><strong>Totals</strong></td>
              <td class="text-center">{{ planned_by_role.values()|sum }}</td>
              <td class="text-center">{{ totals_row.declared }}</td>
              <td class="text-center">{{ totals_row.sched }}</td>
              <td class="text-center">{{ totals_row.done }}</td>
              <td class="text-center">{{ totals_row.vetting }}</td>
              <td class="text-center">{{ totals_row.issued }}</td>
              <td class="text-center">{{ totals_row.signed }}</td>
              <td class="text-center">
                <span class="metric-badge">{{ progress_pct }}%</span>
                <div class="mini-progress">
                  <div class="mini-progress-bar" style="width: {{ progress_pct }}%"></div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Active Job Posts -->
  <div class="modern-card fade-in-up stagger-4">
    <div class="card-body p-4">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-briefcase"></i>
          Active Job Posts
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-modern-primary btn-sm" href="{{ url_for('jobs', eng_id=engagement.id) }}">
            <i class="fas fa-plus"></i> New Job
          </a>
          <a class="btn btn-modern-outline btn-sm" href="{{ url_for('jobs', eng_id=engagement.id) }}">
            <i class="fas fa-list"></i> Manage Jobs
          </a>
        </div>
      </div>

      {% if jobs_active %}
        <div class="table-responsive">
          <table class="table modern-table jobs-table mb-0">
            <thead>
              <tr>
                <th>Title</th>
                <th>Role</th>
                <th class="text-center">Status</th>
                <th class="text-center">Declared</th>
                <th class="text-center">Shortlisted</th>
                <th class="text-center">Created</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for j in jobs_active %}
              <tr onclick="window.location.href='{{ url_for('engagement_job_detail', eng_id=engagement.id, job_id=j.id) }}'">
                <td><strong>{{ j.title }}</strong></td>
                <td>{{ j.role_type or '—' }}</td>
                <td class="text-center">
                  <span class="status-badge {{ 'open' if (j.status or '').lower() == 'open' else 'default' }}">
                    {{ j.status }}
                  </span>
                </td>
                <td class="text-center">
                  <span class="metric-badge">{{ job_declared.get(j.id, 0) }}</span>
                </td>
                <td class="text-center">
                  <span class="metric-badge">{{ job_shortlisted.get(j.id, 0) }}</span>
                </td>
                <td class="text-center">
                  <i class="far fa-calendar me-1"></i>
                  {{ j.created_at.strftime('%Y-%m-%d') if j.created_at else '—' }}
                </td>
                <td class="text-center" onclick="event.stopPropagation();">
                  <a class="btn btn-modern-primary btn-sm" 
                     href="{{ url_for('engagement_job_detail', eng_id=engagement.id, job_id=j.id) }}">
                    <i class="fas fa-arrow-right"></i> Open
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-briefcase"></i>
          </div>
          <div class="empty-state-title">No Active Jobs</div>
          <div class="empty-state-text">Get started by creating your first job post for this engagement.</div>
          <a class="btn btn-modern-primary" href="{{ url_for('jobs', eng_id=engagement.id) }}">
            <i class="fas fa-plus"></i> Create First Job
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Copy link to clipboard (Share button)
  (function(){
    const btn = document.getElementById('btn-copy-link');
    if(!btn) return;
    
    btn.addEventListener('click', async () => {
      const link = btn.getAttribute('data-link') || window.location.href;
      try {
        await navigator.clipboard.writeText(link);
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.style.background = '#22c55e';
        btn.style.color = 'white';
        btn.style.borderColor = '#22c55e';
        
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.style.background = '';
          btn.style.color = '';
          btn.style.borderColor = '';
        }, 2000);
      } catch(e) {
        alert('Copy failed. You can manually copy the address bar URL.');
      }
    });
  })();
</script>
{% endblock %}
