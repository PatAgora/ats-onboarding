{% extends "base.html" %}
{% set hide_topbar = True %}
{% block title %}Engagement · {{ engagement.name }}{% endblock %}

{% block content %}
<style>
  /* Tailwind-inspired utilities */
  .gradient-bg {
    background: linear-gradient(135deg, #030a1d 0%, #1e3a8a 100%);
  }
  
  /* Modern KPI Cards */
  .kpi-card {
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 12px;
    background: white;
    border-left: 4px solid #030a1d;
  }
  
  .kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15) !important;
  }
  
  .kpi-card-body {
    padding: 1.25rem 1rem;
  }
  
  .kpi-icon-wrapper {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.75rem;
    font-size: 1.5rem;
  }
  
  .kpi-card.applications .kpi-icon-wrapper { background: #e2e8f0; color: #475569; }
  .kpi-card.shortlist .kpi-icon-wrapper { background: #e8eef8; color: #1e3a8a; }
  .kpi-card.interview-sched .kpi-icon-wrapper { background: #e8eef8; color: #1e3a8a; }
  .kpi-card.interview-done .kpi-icon-wrapper { background: #e8eef8; color: #1e3a8a; }
  .kpi-card.vetting .kpi-icon-wrapper { background: #ede9fe; color: #7c3aed; }
  .kpi-card.contract-issued .kpi-icon-wrapper { background: #d1fae5; color: #059669; }
  .kpi-card.contract-signed .kpi-icon-wrapper { background: #a7f3d0; color: #047857; }
  
  .kpi-value {
    font-size: clamp(2rem, 4vw, 2.5rem);
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #1f2937 0%, #4b5563 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .kpi-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6b7280;
    line-height: 1.3;
    min-height: 2.6em;
  }
  
  .kpi-grid {
    display: grid;
    gap: 1.25rem;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  
  @media (min-width: 576px) { .kpi-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
  @media (min-width: 992px) { .kpi-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
  @media (min-width: 1200px) { .kpi-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); } }
  
  /* Modern Card Styles */
  .modern-card {
    border-radius: 16px;
    border: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: box-shadow 0.3s ease;
  }
  
  .modern-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }
  
  /* Header Section */
  .page-header {
    background: linear-gradient(135deg, #030a1d 0%, #1e3a8a 100%);
    border-radius: 16px;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  
  .page-header h2 {
    color: white;
    margin-bottom: 0.5rem;
  }
  
  .page-header .badge {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-weight: 600;
    padding: 0.35rem 0.75rem;
    backdrop-filter: blur(10px);
  }
  
  .page-header .info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.95);
  }
  
  .page-header .info-item i {
    opacity: 0.8;
  }
  
  /* Progress Bar */
  .progress-modern {
    height: 12px;
    border-radius: 8px;
    background: #e5e7eb;
    overflow: hidden;
  }
  
  .progress-modern .progress-bar {
    background: linear-gradient(90deg, #059669, #047857);
    border-radius: 8px;
    transition: width 0.6s ease;
  }
  
  .progress-stats {
    display: flex;
    align-items: center;
    gap: 2rem;
  }
  
  .progress-stat-item {
    display: flex;
    flex-direction: column;
  }
  
  .progress-stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .progress-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
  }
  
  /* Table Improvements */
  .modern-table {
    font-size: 0.9rem;
  }
  
  .modern-table thead th {
    background: #f9fafb;
    color: #374151;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    padding: 1rem 0.75rem;
    border: none;
  }
  
  .modern-table tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s ease;
  }
  
  .modern-table tbody tr:hover {
    background: #f9fafb;
  }
  
  .modern-table tbody td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
    border: none;
  }
  
  .modern-table .totals-row {
    background: linear-gradient(90deg, #f9fafb, #f3f4f6);
    font-weight: 700;
    border-top: 2px solid #e5e7eb;
  }
  
  /* Mini Progress Bars in Table */
  .mini-progress {
    height: 4px;
    width: 60px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
    display: inline-block;
    margin-left: 0.5rem;
    vertical-align: middle;
  }
  
  .mini-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #059669, #047857);
    border-radius: 2px;
    transition: width 0.3s ease;
  }
  
  /* Status Badges */
  .status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }
  
  .status-badge.active {
    background: #dcfce7;
    color: #166534;
  }
  
  .status-badge.open {
    background: #e8eef8;
    color: #1e3a8a;
  }
  
  .status-badge.default {
    background: #f3f4f6;
    color: #6b7280;
  }
  
  /* Action Buttons */
  .btn-modern {
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    transition: all 0.2s ease;
    border: none;
  }
  
  .btn-modern-primary {
    background: linear-gradient(135deg, #030a1d 0%, #1e3a8a 100%);
    color: white;
  }
  
  .btn-modern-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    color: white;
  }
  
  .btn-modern-outline {
    background: white;
    border: 2px solid #e5e7eb;
    color: #374151;
  }
  
  .btn-modern-outline:hover {
    border-color: #1e3a8a;
    color: #1e3a8a;
    background: #f9fafb;
  }
  
  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border-radius: 12px;
    border: 2px dashed #d1d5db;
  }
  
  .empty-state-icon {
    font-size: 3rem;
    color: #d1d5db;
    margin-bottom: 1rem;
  }
  
  .empty-state-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #374151;
    margin-bottom: 0.5rem;
  }
  
  .empty-state-text {
    color: #6b7280;
    margin-bottom: 1.5rem;
  }
  
  /* Jobs Table */
  .jobs-table tbody tr {
    cursor: pointer;
  }
  
  .metric-badge {
    background: #f3f4f6;
    color: #374151;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.875rem;
  }
  
  /* Section Headers */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }
  
  .section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .section-title i {
    color: #1e3a8a;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .page-header {
      padding: 1.5rem;
    }
    
    .kpi-card-body {
      padding: 1rem 0.75rem;
    }
    
    .kpi-icon-wrapper {
      width: 40px;
      height: 40px;
      font-size: 1.25rem;
    }
    
    .kpi-value {
      font-size: 1.75rem;
    }
  }
  
  /* Animation for load */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .fade-in-up {
    animation: fadeInUp 0.5s ease forwards;
  }
  
  .stagger-1 { animation-delay: 0.1s; opacity: 0; }
  .stagger-2 { animation-delay: 0.2s; opacity: 0; }
  .stagger-3 { animation-delay: 0.3s; opacity: 0; }
  .stagger-4 { animation-delay: 0.4s; opacity: 0; }
  
  /* Delivery Plan Tiles */
  .delivery-tiles {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }
  
  /* Intake Table Styles */
  .intake-group-start td {
    border-top: 2px solid #1e3a8a !important;
  }
  
  /* Delivery Plan Table with Intakes */
  .delivery-plan-table thead th {
    background: linear-gradient(135deg, #030a1d 0%, #1e3a8a 100%);
    color: white;
    font-weight: 600;
    font-size: 0.8rem;
    padding: 0.75rem 0.5rem;
    text-align: center;
    border: none;
  }
  
  .delivery-plan-table thead th:first-child {
    text-align: left;
    border-radius: 8px 0 0 0;
  }
  
  .delivery-plan-table thead th:last-child {
    border-radius: 0 8px 0 0;
  }
  
  .delivery-plan-table tbody td {
    padding: 0.6rem 0.5rem;
    vertical-align: middle;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.875rem;
  }
  
  .role-main-row {
    background: #f8fafc;
  }
  
  .role-main-row td {
    border-top: 2px solid #cbd5e1 !important;
  }
  
  .intake-header-row {
    background: #f1f5f9;
  }
  
  .intake-header-row td {
    padding: 0.4rem 0.5rem !important;
    border-bottom: none !important;
  }
  
  .intake-label {
    color: #64748b;
    font-size: 0.8rem;
    padding-left: 1rem !important;
  }
  
  .intake-sub-row {
    background: white;
  }
  
  .intake-sub-row td {
    font-size: 0.825rem;
    color: #475569;
  }
  
  .intake-sub-row .intake-date-cell {
    padding-left: 1.5rem !important;
  }
  
  .intake-bullet {
    color: #1e3a8a;
    font-weight: bold;
    margin-right: 0.5rem;
  }
  
  .totals-row {
    background: #f1f5f9;
    border-top: 2px solid #1e3a8a !important;
  }
  
  .totals-row td {
    border-top: 2px solid #1e3a8a !important;
  }
  
  /* Progress Bar Cell */
  .progress-bar-cell {
    width: 80px;
    height: 20px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    display: inline-block;
    vertical-align: middle;
  }
  
  .progress-bar-fill {
    height: 100%;
    transition: width 0.3s ease;
  }
  
  .progress-green {
    background: linear-gradient(90deg, #22c55e, #16a34a);
  }
  
  .progress-yellow {
    background: linear-gradient(90deg, #facc15, #eab308);
  }
  
  .progress-orange {
    background: linear-gradient(90deg, #fb923c, #f97316);
  }
  
  .progress-red {
    background: linear-gradient(90deg, #ef4444, #dc2626);
  }
  
  @media (max-width: 992px) {
    .delivery-tiles {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 576px) {
    .delivery-tiles {
      grid-template-columns: 1fr;
    }
  }
  
  .delivery-tile {
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .delivery-tile:hover {
    border-color: #1e3a8a;
    box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15);
    transform: translateY(-2px);
  }
  
  .delivery-tile-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.75rem;
    font-size: 1.25rem;
  }
  
  .delivery-tile-value {
    font-size: 2rem;
    font-weight: 800;
    color: #1f2937;
    line-height: 1;
    margin-bottom: 0.5rem;
  }
  
  .delivery-tile-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6b7280;
  }
  
  /* Delivery Modal */
  .delivery-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1050;
    justify-content: center;
    align-items: center;
  }
  
  .delivery-modal.show {
    display: flex;
  }
  
  .delivery-modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
  }
  
  .delivery-modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .delivery-modal-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 700;
    color: #1f2937;
  }
  
  .delivery-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }
  
  .delivery-modal-close:hover {
    color: #1f2937;
  }
  
  .delivery-modal-body {
    padding: 1.5rem;
    max-height: calc(80vh - 70px);
    overflow-y: auto;
  }
  
  .associate-search {
    margin-bottom: 1rem;
  }
  
  .associate-search input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
  }
  
  .associate-search input:focus {
    outline: none;
    border-color: #1e3a8a;
  }
  
  .associate-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .associate-item {
    padding: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.15s;
  }
  
  .associate-item:hover {
    background: #f9fafb;
  }
  
  .associate-info {
    flex: 1;
  }
  
  .associate-name {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
  }
  
  .associate-role {
    font-size: 0.875rem;
    color: #6b7280;
  }
  
  .associate-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  /* Bulk Actions Bar */
  .bulk-actions-bar {
    background: linear-gradient(135deg, #030a1d 0%, #1e3a8a 100%);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: none;
    align-items: center;
    justify-content: space-between;
  }
  
  .bulk-actions-bar.show {
    display: flex;
  }
  
  .bulk-select-count {
    font-weight: 600;
  }
  
  .bulk-action-btns {
    display: flex;
    gap: 0.5rem;
  }
  
  .bulk-action-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }
  
  .bulk-action-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }
</style>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">

<div class="container-xxl px-4 pt-3 pb-4">
  <!-- Enhanced Header -->
  <div class="page-header fade-in-up stagger-1">
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-3">
      <div>
        <h2 class="fw-bold mb-2">
          {{ engagement.name }}
          {% if engagement.ref %}
            <span class="badge ms-2">{{ engagement.ref }}</span>
          {% endif %}
        </h2>
        <div class="d-flex flex-wrap gap-3">
          <div class="info-item">
            <i class="fas fa-building"></i>
            <span><strong>{{ engagement.client or "—" }}</strong></span>
          </div>
          <div class="info-item">
            <i class="fas fa-circle-check"></i>
            <span>Status: <strong>{{ engagement.status or '—' }}</strong></span>
          </div>
        </div>
      </div>
      
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-modern-outline btn-sm" href="{{ url_for('engagement_plan', eng_id=engagement.id) }}">
          <i class="fas fa-sliders"></i> Edit Plan
        </a>
        <button class="btn btn-modern-outline btn-sm" id="btn-copy-link" data-link="{{ request.url }}">
          <i class="fas fa-share-nodes"></i> Share
        </button>
        <a class="btn btn-modern-outline btn-sm" href="{{ url_for('engagements') }}">
          <i class="fas fa-arrow-left"></i> Back
        </a>
      </div>
    </div>
  </div>

  <!-- Delivery Plan Summary Tiles -->
  <div class="modern-card mb-4 fade-in-up stagger-2">
    <div class="card-body p-4">
      <div class="section-header mb-3">
        <div class="section-title">
          <i class="fas fa-clipboard-list"></i>
          Delivery Plan Summary
        </div>
        <a class="btn btn-modern-outline btn-sm" href="{{ url_for('engagement_plan', eng_id=engagement.id) }}">
          <i class="fas fa-edit"></i> Edit Plan
        </a>
      </div>
      
      <div class="delivery-tiles">
        <!-- Total Delivery Target -->
        <div class="delivery-tile" onclick="showDeliveryModal('target')">
          <div class="delivery-tile-icon" style="background: #e8eef8; color: #1e3a8a;">
            <i class="fas fa-bullseye"></i>
          </div>
          <div class="delivery-tile-value">{{ planned_by_role.values()|sum }}</div>
          <div class="delivery-tile-label">Total Delivery Target</div>
        </div>
        
        <!-- On-Contract Associates -->
        <div class="delivery-tile" onclick="showDeliveryModal('on_contract')">
          <div class="delivery-tile-icon" style="background: #dcfce7; color: #166534;">
            <i class="fas fa-user-check"></i>
          </div>
          <div class="delivery-tile-value">{{ tile_contract_signed }}</div>
          <div class="delivery-tile-label">On-Contract Associates</div>
        </div>
        
        <!-- Scheduled Starters -->
        <div class="delivery-tile" onclick="showDeliveryModal('scheduled')">
          <div class="delivery-tile-icon" style="background: #fef3c7; color: #92400e;">
            <i class="fas fa-calendar-plus"></i>
          </div>
          <div class="delivery-tile-value">{{ totals_row.get('scheduled', 0) }}</div>
          <div class="delivery-tile-label">Scheduled Starters</div>
        </div>
        
        <!-- Left to Fill -->
        <div class="delivery-tile" onclick="showDeliveryModal('left_to_fill')">
          <div class="delivery-tile-icon" style="background: #fee2e2; color: #991b1b;">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="delivery-tile-value">{{ totals_row.get('left_to_fill', 0) }}</div>
          <div class="delivery-tile-label">Left to Fill</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delivery Plan Table -->
  <div class="modern-card mb-4 fade-in-up stagger-3">
    <div class="card-body p-4">
      <div class="section-header mb-3">
        <div class="section-title">
          <i class="fas fa-table"></i>
          Delivery Plan by Role
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table modern-table delivery-plan-table mb-0">
          <thead>
            <tr>
              <th>Role</th>
              <th class="text-center">Target</th>
              <th class="text-center">On Contract</th>
              <th class="text-center">Scheduled Starters</th>
              <th class="text-center">Left to Fill</th>
              <th class="text-center" style="width: 120px;">Progress Bar</th>
              <th class="text-center">Pay Rate</th>
              <th class="text-center">Bill Rate</th>
            </tr>
          </thead>
          <tbody>
            {% for role in display_roles %}
              {% set m = role_metrics.get(role, {}) %}
              {% set planned = m.get('planned', 0) %}
              {% set signed = m.get('signed', 0) %}
              {% set scheduled = m.get('scheduled', 0) %}
              {% set left_to_fill = m.get('left_to_fill', 0) %}
              {% set pay_rate = m.get('pay_rate', 0) %}
              {% set bill_rate = m.get('bill_rate', 0) %}
              {% set role_progress = (signed * 100 / planned)|int if planned > 0 else 0 %}
              {% set intake_data = intake_by_role.get(role, {}) %}
              {% set intakes = intake_data.get('intakes', []) %}
              
              <!-- Main Role Row -->
              <tr class="role-main-row">
                <td><strong>{{ role }}</strong></td>
                <td class="text-center">{{ planned }}</td>
                <td class="text-center">{{ signed }}</td>
                <td class="text-center">{{ scheduled }}</td>
                <td class="text-center">{{ left_to_fill }}</td>
                <td class="text-center">
                  <div class="progress-bar-cell">
                    <div class="progress-bar-fill {% if role_progress >= 100 %}progress-green{% elif role_progress >= 50 %}progress-yellow{% else %}progress-orange{% endif %}" style="width: {{ role_progress }}%;"></div>
                  </div>
                </td>
                <td class="text-center" rowspan="{{ intakes|length + 1 if intakes else 1 }}">{% if pay_rate %}£{{ pay_rate|int }}{% else %}—{% endif %}</td>
                <td class="text-center" rowspan="{{ intakes|length + 1 if intakes else 1 }}">{% if bill_rate %}£{{ bill_rate|int }}{% else %}—{% endif %}</td>
              </tr>
              
              <!-- Intake Sub-Rows -->
              {% if intakes %}
                <tr class="intake-header-row">
                  <td colspan="6" class="intake-label"><em>Intake Date</em></td>
                </tr>
                {% for intake in intakes %}
                  {% set intake_progress = (intake.planned_count * 100 / planned)|int if planned > 0 else 0 %}
                  {% set intake_signed = ((signed * intake.planned_count) / planned)|int if planned > 0 else 0 %}
                  {% set intake_scheduled = ((scheduled * intake.planned_count) / planned)|int if planned > 0 else 0 %}
                  {% set intake_left = intake.planned_count - intake_signed - intake_scheduled %}
                  {% set intake_fill_pct = (intake_signed * 100 / intake.planned_count)|int if intake.planned_count > 0 else 0 %}
                  <tr class="intake-sub-row">
                    <td class="intake-date-cell">
                      <span class="intake-bullet">•</span>
                      {{ intake.date_display }}
                    </td>
                    <td class="text-center">{{ intake.planned_count }}</td>
                    <td class="text-center">{{ intake_signed }}</td>
                    <td class="text-center">{{ intake_scheduled }}</td>
                    <td class="text-center">{{ intake_left if intake_left > 0 else 0 }}</td>
                    <td class="text-center">
                      <div class="progress-bar-cell">
                        <div class="progress-bar-fill {% if intake_fill_pct >= 100 %}progress-green{% elif intake_fill_pct >= 50 %}progress-yellow{% elif intake_left > 0 %}progress-red{% else %}progress-orange{% endif %}" style="width: {{ intake_fill_pct }}%;"></div>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}
            {% endfor %}
            
            <!-- Totals Row -->
            <tr class="totals-row">
              <td><strong>Totals</strong></td>
              <td class="text-center"><strong>{{ planned_by_role.values()|sum }}</strong></td>
              <td class="text-center"><strong>{{ totals_row.signed }}</strong></td>
              <td class="text-center"><strong>{{ totals_row.get('scheduled', 0) }}</strong></td>
              <td class="text-center"><strong>{{ totals_row.get('left_to_fill', 0) }}</strong></td>
              <td class="text-center">
                <div class="progress-bar-cell">
                  <div class="progress-bar-fill {% if progress_pct >= 100 %}progress-green{% elif progress_pct >= 50 %}progress-yellow{% else %}progress-orange{% endif %}" style="width: {{ progress_pct }}%;"></div>
                </div>
              </td>
              <td class="text-center">—</td>
              <td class="text-center">—</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Active Job Posts -->
  <div class="modern-card fade-in-up stagger-4">
    <div class="card-body p-4">
      <div class="section-header">
        <div class="section-title">
          <i class="fas fa-briefcase"></i>
          Active Job Posts
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-modern-primary btn-sm" href="{{ url_for('jobs', eng_id=engagement.id) }}">
            <i class="fas fa-plus"></i> New Job
          </a>
          <a class="btn btn-modern-outline btn-sm" href="{{ url_for('jobs', eng_id=engagement.id) }}">
            <i class="fas fa-list"></i> Manage Jobs
          </a>
        </div>
      </div>

      {% if jobs_active %}
        <div class="table-responsive">
          <table class="table modern-table jobs-table mb-0">
            <thead>
              <tr>
                <th>Title</th>
                <th>Role</th>
                <th class="text-center">Status</th>
                <th class="text-center">Declared</th>
                <th class="text-center">Shortlisted</th>
                <th class="text-center">Created</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for j in jobs_active %}
              <tr onclick="window.location.href='{{ url_for('engagement_job_detail', eng_id=engagement.id, job_id=j.id) }}'">
                <td><strong>{{ j.title }}</strong></td>
                <td>{{ j.role_type or '—' }}</td>
                <td class="text-center">
                  <span class="status-badge {{ 'open' if (j.status or '').lower() == 'open' else 'default' }}">
                    {{ j.status }}
                  </span>
                </td>
                <td class="text-center">
                  <span class="metric-badge">{{ job_declared.get(j.id, 0) }}</span>
                </td>
                <td class="text-center">
                  <span class="metric-badge">{{ job_shortlisted.get(j.id, 0) }}</span>
                </td>
                <td class="text-center">
                  <i class="far fa-calendar me-1"></i>
                  {{ j.created_at.strftime('%Y-%m-%d') if j.created_at else '—' }}
                </td>
                <td class="text-center" onclick="event.stopPropagation();">
                  <a class="btn btn-modern-primary btn-sm" 
                     href="{{ url_for('engagement_job_detail', eng_id=engagement.id, job_id=j.id) }}">
                    <i class="fas fa-arrow-right"></i> Open
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-briefcase"></i>
          </div>
          <div class="empty-state-title">No Active Jobs</div>
          <div class="empty-state-text">Get started by creating your first job post for this engagement.</div>
          <a class="btn btn-modern-primary" href="{{ url_for('jobs', eng_id=engagement.id) }}">
            <i class="fas fa-plus"></i> Create First Job
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Delivery Modal for Associate Lists -->
<div class="delivery-modal" id="deliveryModal">
  <div class="delivery-modal-content">
    <div class="delivery-modal-header">
      <h3 id="modalTitle">Associates</h3>
      <button class="delivery-modal-close" onclick="closeDeliveryModal()">&times;</button>
    </div>
    <div class="delivery-modal-body">
      <div class="associate-search">
        <input type="text" id="associateSearch" placeholder="Search associates..." oninput="filterAssociates()">
      </div>
      
      <div class="bulk-actions-bar" id="bulkActionsBar">
        <span class="bulk-select-count"><span id="selectedCount">0</span> selected</span>
        <div class="bulk-action-btns">
          <button class="bulk-action-btn" onclick="issueContractsBulk()">
            <i class="fas fa-file-contract me-1"></i> Issue Contracts
          </button>
          <button class="bulk-action-btn" onclick="clearSelection()">
            <i class="fas fa-times me-1"></i> Clear
          </button>
        </div>
      </div>
      
      <ul class="associate-list" id="associateList">
        <!-- Populated by JavaScript -->
      </ul>
    </div>
  </div>
</div>

<script>
  // Copy link to clipboard (Share button)
  (function(){
    const btn = document.getElementById('btn-copy-link');
    if(!btn) return;
    
    btn.addEventListener('click', async () => {
      const link = btn.getAttribute('data-link') || window.location.href;
      try {
        await navigator.clipboard.writeText(link);
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.style.background = '#22c55e';
        btn.style.color = 'white';
        btn.style.borderColor = '#22c55e';
        
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.style.background = '';
          btn.style.color = '';
          btn.style.borderColor = '';
        }, 2000);
      } catch(e) {
        alert('Copy failed. You can manually copy the address bar URL.');
      }
    });
  })();
  
  // Delivery Modal Functions
  const associatesData = {
    on_contract: {{ associates_on_engagement | tojson if associates_on_engagement else '[]' }},
    scheduled: [],
    left_to_fill: [],
    target: []
  };
  
  let currentModalType = '';
  let selectedAssociates = new Set();
  
  function showDeliveryModal(type) {
    currentModalType = type;
    selectedAssociates.clear();
    updateBulkActionsBar();
    
    const modal = document.getElementById('deliveryModal');
    const title = document.getElementById('modalTitle');
    const list = document.getElementById('associateList');
    
    const titles = {
      'target': 'Delivery Target by Role',
      'on_contract': 'On-Contract Associates',
      'scheduled': 'Scheduled Starters',
      'left_to_fill': 'Left to Fill - Ready to Contract'
    };
    
    title.textContent = titles[type] || 'Associates';
    
    let html = '';
    const associates = associatesData[type] || [];
    
    if (type === 'on_contract' && associates.length > 0) {
      associates.forEach((a, idx) => {
        html += `
          <li class="associate-item" data-name="${(a.name || '').toLowerCase()}" data-role="${(a.role || '').toLowerCase()}">
            <div class="associate-info">
              <div class="associate-name">${a.name || 'Unknown'}</div>
              <div class="associate-role">${a.role || 'No role'} • AI Score: ${a.ai_score || 0}</div>
            </div>
            <div class="associate-actions">
              <a href="/candidate/${a.id}" class="btn btn-modern-outline btn-sm">
                <i class="fas fa-user"></i> View Profile
              </a>
            </div>
          </li>
        `;
      });
    } else if (type === 'target') {
      // Show roles breakdown
      {% for role in display_roles %}
      {% set m = role_metrics.get(role, {}) %}
      html += `
        <li class="associate-item">
          <div class="associate-info">
            <div class="associate-name">{{ role }}</div>
            <div class="associate-role">Target: {{ m.get('planned', 0) }} • Filled: {{ m.get('signed', 0) }}</div>
          </div>
        </li>
      `;
      {% endfor %}
    } else if (associates.length === 0) {
      html = '<li class="associate-item"><div class="associate-info"><div class="associate-name">No associates found</div></div></li>';
    }
    
    list.innerHTML = html;
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  
  function closeDeliveryModal() {
    const modal = document.getElementById('deliveryModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
    selectedAssociates.clear();
    updateBulkActionsBar();
  }
  
  function filterAssociates() {
    const query = document.getElementById('associateSearch').value.toLowerCase();
    const items = document.querySelectorAll('#associateList .associate-item');
    
    items.forEach(item => {
      const name = item.dataset.name || '';
      const role = item.dataset.role || '';
      const matches = name.includes(query) || role.includes(query);
      item.style.display = matches ? '' : 'none';
    });
  }
  
  function toggleAssociateSelection(id, checkbox) {
    if (checkbox.checked) {
      selectedAssociates.add(id);
    } else {
      selectedAssociates.delete(id);
    }
    updateBulkActionsBar();
  }
  
  function updateBulkActionsBar() {
    const bar = document.getElementById('bulkActionsBar');
    const countEl = document.getElementById('selectedCount');
    countEl.textContent = selectedAssociates.size;
    bar.classList.toggle('show', selectedAssociates.size > 0);
  }
  
  function clearSelection() {
    selectedAssociates.clear();
    document.querySelectorAll('#associateList input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateBulkActionsBar();
  }
  
  function issueContractsBulk() {
    if (selectedAssociates.size === 0) {
      alert('Please select at least one associate.');
      return;
    }
    // TODO: Implement bulk contract issuance
    alert(`Issuing contracts for ${selectedAssociates.size} associates...`);
  }
  
  // Close modal on backdrop click
  document.getElementById('deliveryModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeDeliveryModal();
    }
  });
  
  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeDeliveryModal();
    }
  });
</script>
{% endblock %}
