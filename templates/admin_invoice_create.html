{% extends "base.html" %}

{% block title %}Create Invoice - OS1{% endblock %}

{% block content %}
<style>
    .page-header {
        margin-bottom: 1.5rem;
    }
    .page-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1f2937;
    }
    .invoice-form-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        padding: 2rem;
    }
    .form-section {
        margin-bottom: 2rem;
    }
    .form-section h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }
    .line-items-table {
        width: 100%;
        border-collapse: collapse;
    }
    .line-items-table th,
    .line-items-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    .line-items-table th {
        background: #f8fafc;
        font-weight: 600;
        font-size: 0.875rem;
        color: #374151;
    }
    .line-items-table input {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 0.5rem;
    }
    .line-items-table input:focus {
        outline: none;
        border-color: #3b82f6;
    }
    .add-line-btn {
        margin-top: 1rem;
    }
    .totals-section {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    .totals-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
    }
    .totals-row.total {
        font-weight: 700;
        font-size: 1.25rem;
        border-top: 2px solid #e5e7eb;
        padding-top: 1rem;
        margin-top: 0.5rem;
    }
    .remove-line-btn {
        background: #fee2e2;
        color: #991b1b;
        border: none;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        cursor: pointer;
    }
    .remove-line-btn:hover {
        background: #fecaca;
    }
</style>

<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="fas fa-file-invoice-dollar me-2"></i>Create Invoice</h1>
        <p class="text-muted mb-0">Generate a new invoice for a client</p>
    </div>
    <a href="{{ url_for('admin_invoices') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Back to Invoices
    </a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<form method="POST" action="{{ url_for('admin_create_invoice') }}" id="invoiceForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="row">
        <div class="col-lg-8">
            <div class="invoice-form-card">
                <!-- Client Details -->
                <div class="form-section">
                    <h3><i class="fas fa-building me-2"></i>Client Details</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Engagement</label>
                            <select class="form-select" name="engagement_id" id="engagementSelect" onchange="updateEngagementDetails()">
                                <option value="">-- Select Engagement --</option>
                                {% for eng in engagements %}
                                <option value="{{ eng.id }}" data-client="{{ eng.client }}" data-name="{{ eng.name }}">
                                    {{ eng.name }} ({{ eng.client }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Client Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="client_name" id="clientName" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Engagement Name</label>
                            <input type="text" class="form-control" name="engagement_name" id="engagementName">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" name="due_date" id="dueDate">
                        </div>
                    </div>
                </div>
                
                <!-- Line Items -->
                <div class="form-section">
                    <h3><i class="fas fa-list me-2"></i>Line Items</h3>
                    <table class="line-items-table" id="lineItemsTable">
                        <thead>
                            <tr>
                                <th style="width:50%">Description</th>
                                <th style="width:15%">Quantity</th>
                                <th style="width:20%">Rate (£)</th>
                                <th style="width:15%">Amount</th>
                                <th style="width:50px"></th>
                            </tr>
                        </thead>
                        <tbody id="lineItemsBody">
                            <tr class="line-item-row">
                                <td><input type="text" name="item_description[]" placeholder="Service description" onchange="calculateTotals()"></td>
                                <td><input type="number" name="item_quantity[]" value="1" min="0" step="0.5" onchange="calculateTotals()"></td>
                                <td><input type="number" name="item_rate[]" value="0" min="0" step="0.01" onchange="calculateTotals()"></td>
                                <td class="line-amount">£0.00</td>
                                <td><button type="button" class="remove-line-btn" onclick="removeLine(this)"><i class="fas fa-times"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-outline-primary add-line-btn" onclick="addLineItem()">
                        <i class="fas fa-plus me-1"></i> Add Line Item
                    </button>
                </div>
                
                <!-- Notes -->
                <div class="form-section mb-0">
                    <h3><i class="fas fa-sticky-note me-2"></i>Notes</h3>
                    <textarea class="form-control" name="notes" rows="3" placeholder="Additional notes or payment instructions..."></textarea>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Summary Card -->
            <div class="invoice-form-card">
                <h3 class="mb-3"><i class="fas fa-calculator me-2"></i>Summary</h3>
                
                <div class="mb-3">
                    <label class="form-label">Payment Terms</label>
                    <select class="form-select" name="payment_terms">
                        <option value="Due on Receipt">Due on Receipt</option>
                        <option value="Net 15">Net 15</option>
                        <option value="Net 30" selected>Net 30</option>
                        <option value="Net 45">Net 45</option>
                        <option value="Net 60">Net 60</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">VAT Rate (%)</label>
                    <input type="number" class="form-control" name="vat_rate" id="vatRate" value="20" min="0" max="100" step="0.1" onchange="calculateTotals()">
                </div>
                
                <div class="totals-section">
                    <div class="totals-row">
                        <span>Subtotal</span>
                        <span id="subtotal">£0.00</span>
                    </div>
                    <div class="totals-row">
                        <span>VAT (<span id="vatRateDisplay">20</span>%)</span>
                        <span id="vatAmount">£0.00</span>
                    </div>
                    <div class="totals-row total">
                        <span>Total</span>
                        <span id="totalAmount">£0.00</span>
                    </div>
                </div>
                
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Create Invoice
                    </button>
                    <a href="{{ url_for('admin_invoices') }}" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
function updateEngagementDetails() {
    const select = document.getElementById('engagementSelect');
    const option = select.options[select.selectedIndex];
    
    if (option.value) {
        document.getElementById('clientName').value = option.dataset.client || '';
        document.getElementById('engagementName').value = option.dataset.name || '';
        
        // Set default due date to 30 days from now
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 30);
        document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
    }
}

function addLineItem() {
    const tbody = document.getElementById('lineItemsBody');
    const newRow = document.createElement('tr');
    newRow.className = 'line-item-row';
    newRow.innerHTML = `
        <td><input type="text" name="item_description[]" placeholder="Service description" onchange="calculateTotals()"></td>
        <td><input type="number" name="item_quantity[]" value="1" min="0" step="0.5" onchange="calculateTotals()"></td>
        <td><input type="number" name="item_rate[]" value="0" min="0" step="0.01" onchange="calculateTotals()"></td>
        <td class="line-amount">£0.00</td>
        <td><button type="button" class="remove-line-btn" onclick="removeLine(this)"><i class="fas fa-times"></i></button></td>
    `;
    tbody.appendChild(newRow);
}

function removeLine(btn) {
    const rows = document.querySelectorAll('.line-item-row');
    if (rows.length > 1) {
        btn.closest('tr').remove();
        calculateTotals();
    }
}

function calculateTotals() {
    const rows = document.querySelectorAll('.line-item-row');
    let subtotal = 0;
    
    rows.forEach(row => {
        const qty = parseFloat(row.querySelector('input[name="item_quantity[]"]').value) || 0;
        const rate = parseFloat(row.querySelector('input[name="item_rate[]"]').value) || 0;
        const amount = qty * rate;
        row.querySelector('.line-amount').textContent = '£' + amount.toFixed(2);
        subtotal += amount;
    });
    
    const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
    const vatAmount = subtotal * (vatRate / 100);
    const total = subtotal + vatAmount;
    
    document.getElementById('subtotal').textContent = '£' + subtotal.toFixed(2);
    document.getElementById('vatRateDisplay').textContent = vatRate.toFixed(1);
    document.getElementById('vatAmount').textContent = '£' + vatAmount.toFixed(2);
    document.getElementById('totalAmount').textContent = '£' + total.toFixed(2);
}

// Initialize
document.addEventListener('DOMContentLoaded', calculateTotals);
</script>
{% endblock %}
