{% extends "base.html" %}

{% block title %}Placements · Optimus OS1{% endblock %}

{% block head %}
<style>
  /* ===== Placements Page Styles ===== */
  .placements-header {
    background: linear-gradient(135deg, #030a1d 0%, #1e3a8a 100%);
    color: white;
    padding: 2rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  
  .placements-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
  }
  
  .placements-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
  }
  
  /* Summary Cards */
  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .summary-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-left: 4px solid #030a1d;
  }
  
  .summary-card .card-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }
  
  .summary-card .card-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1f2937;
  }
  
  .summary-card .card-value.currency::before {
    content: "£";
    font-size: 1.25rem;
    font-weight: 500;
    margin-right: 0.125rem;
  }
  
  /* Placements Table */
  .placements-table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  
  .placements-table-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .placements-table-header h2 {
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .placements-table-header h2 .badge {
    background: #10b981;
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
  }
  
  .table-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .placements-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .placements-table th {
    background: #f9fafb;
    padding: 0.875rem 1rem;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .placements-table td {
    padding: 1rem;
    border-bottom: 1px solid #f3f4f6;
    font-size: 0.875rem;
    color: #374151;
  }
  
  .placements-table tbody tr:hover {
    background: #f9fafb;
  }
  
  .placements-table .associate-cell {
    display: flex;
    flex-direction: column;
  }
  
  .placements-table .associate-name {
    font-weight: 600;
    color: #1f2937;
  }
  
  .placements-table .associate-email {
    font-size: 0.75rem;
    color: #6b7280;
  }
  
  .placements-table .client-cell {
    font-weight: 500;
  }
  
  .placements-table .engagement-cell {
    display: flex;
    flex-direction: column;
  }
  
  .placements-table .engagement-name {
    font-weight: 500;
  }
  
  .placements-table .engagement-ref {
    font-size: 0.75rem;
    color: #6b7280;
  }
  
  .placements-table .rate-cell {
    font-weight: 600;
    color: #059669;
  }
  
  .placements-table .date-cell {
    white-space: nowrap;
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .status-badge.signed {
    background: #dcfce7;
    color: #166534;
  }
  
  .status-badge.on_notice {
    background: #fef3c7;
    color: #92400e;
  }
  
  /* Actions */
  .action-btn {
    padding: 0.375rem 0.625rem;
    border-radius: 6px;
    font-size: 0.75rem;
    border: 1px solid #d1d5db;
    background: white;
    color: #374151;
    cursor: pointer;
    transition: all 0.15s;
  }
  
  .action-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }
  
  .action-btn.primary {
    background: #1e3a8a;
    color: white;
    border-color: #1e3a8a;
  }
  
  .action-btn.primary:hover {
    background: #1e3a8a;
  }
  
  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
  }
  
  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  /* Filter Section - Below Header, Above Summary Tiles */
  .filter-section {
    background: white;
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .filter-section h3 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .filter-section h3 i {
    color: #1e3a8a;
  }
  
  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
  }
  
  /* Prevent loading cursor on filter elements */
  .filter-section,
  .filter-section * {
      cursor: default;
  }
  
  .filter-section button,
  .filter-section .dropdown-toggle,
  .filter-section input[type="checkbox"],
  .filter-section label {
      cursor: pointer;
  }
  
  .filter-actions {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
  }
  
  .filter-btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid transparent;
    transition: all 0.2s;
    height: 38px;
    cursor: pointer;
  }
  
  .filter-btn-apply {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    color: white;
    border-color: #1e3a8a;
  }
  
  .filter-btn-apply:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(30, 58, 138, 0.3);
  }
  
  .filter-btn-clear {
    background: white;
    color: #6b7280;
    border-color: #d1d5db;
  }
  
  .filter-btn-clear:hover {
    background: #f9fafb;
    color: #374151;
    border-color: #9ca3af;
  }
  
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 150px;
    max-width: 200px;
  }
  
  .filter-group label {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
  }
  
  /* Multi-select Dropdown */
  .dropdown-multiselect {
      position: relative;
      width: 100%;
  }
  
  .dropdown-multiselect .dropdown-toggle {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
      background: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: border-color 0.2s, box-shadow 0.2s;
      text-align: left;
      height: 38px;
  }
  
  .dropdown-multiselect .dropdown-toggle:hover {
      border-color: #9ca3af;
  }
  
  .dropdown-multiselect .dropdown-toggle .selected-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #374151;
  }
  
  .dropdown-multiselect .dropdown-toggle .selected-text.placeholder {
      color: #9ca3af;
  }
  
  .dropdown-multiselect .dropdown-toggle i {
      margin-left: 0.5rem;
      color: #6b7280;
      transition: transform 0.2s;
  }
  
  .dropdown-multiselect.open .dropdown-toggle i {
      transform: rotate(180deg);
  }
  
  .dropdown-multiselect .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 1000;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-top: 4px;
      max-height: 250px;
      overflow-y: auto;
      display: none;
  }
  
  .dropdown-multiselect.open .dropdown-menu {
      display: block;
  }
  
  .dropdown-multiselect .dropdown-item {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.15s;
      font-size: 0.85rem;
  }
  
  .dropdown-multiselect .dropdown-item:hover {
      background: #f3f4f6;
  }
  
  .dropdown-multiselect .dropdown-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #1e3a8a;
  }
  
  .dropdown-multiselect .dropdown-item label {
      flex: 1;
      cursor: pointer;
      margin: 0;
      font-weight: normal;
  }
  
  .dropdown-multiselect .dropdown-search {
      padding: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      background: white;
  }
  
  .dropdown-multiselect .dropdown-search input {
      width: 100%;
      padding: 0.4rem 0.6rem;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.8rem;
  }
  
  .dropdown-multiselect .select-actions {
      padding: 0.5rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 0.5rem;
      position: sticky;
      bottom: 0;
      background: white;
  }
  
  .dropdown-multiselect .select-actions button {
      flex: 1;
      padding: 0.35rem 0.5rem;
      font-size: 0.75rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
  }
  
  .dropdown-multiselect .select-actions .btn-select-all {
      background: #e8eef8;
      color: #1e3a8a;
  }
  
  .dropdown-multiselect .select-actions .btn-clear-all {
      background: #f3f4f6;
      color: #374151;
  }
  

  
  /* Charts Section */
  .charts-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .chart-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .chart-card h3 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .chart-card h3 i {
    color: #1e3a8a;
  }
  
  .chart-container {
    position: relative;
    height: 220px;
  }
  
  /* Client List */
  .client-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .client-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f3f4f6;
    font-size: 0.875rem;
  }
  
  .client-list li:last-child {
    border-bottom: none;
  }
  
  .client-list .client-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .client-color-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }
  
  .client-list .client-metrics {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: #6b7280;
  }
  
  .client-list .client-metrics strong {
    color: #1f2937;
  }
  
  /* Responsive */
  @media (max-width: 1024px) {
    .placements-table-container {
      overflow-x: auto;
    }
    
    .placements-table {
      min-width: 900px;
    }
    
    .charts-row {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="placements-header">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h1><i class="fas fa-user-tie me-2"></i>Placements</h1>
      <p>Active on-contract associates across all engagements</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-light btn-sm" onclick="exportToCSV()">
        <i class="fas fa-download me-1"></i> Export CSV
      </button>
    </div>
  </div>
</div>

<!-- Filter Section - Below Header, Above Summary Tiles -->
<div class="filter-section">
  <h3><i class="fas fa-filter"></i> Filter Placements</h3>
  <form id="filterForm" method="GET" action="{{ url_for('placements') }}">
    <div class="filter-row">
      <div class="filter-group">
        <label>Name</label>
        <div class="dropdown-multiselect" id="nameDropdown">
          <button type="button" class="dropdown-toggle" onclick="toggleDropdown('nameDropdown')">
            <span class="selected-text">
              {% if name_filter %}{{ name_filter|length }} selected{% else %}All Names{% endif %}
            </span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="dropdown-menu">
            <div class="dropdown-search">
              <input type="text" placeholder="Search names..." onkeyup="filterDropdownItems(this, 'nameDropdown')">
            </div>
            <div class="dropdown-items">
              {% for name in all_names %}
              <div class="dropdown-item">
                <input type="checkbox" id="name_{{ loop.index }}" name="name" value="{{ name }}" {% if name in name_filter %}checked{% endif %} onchange="updateDropdownText('nameDropdown', 'All Names')">
                <label for="name_{{ loop.index }}">{{ name }}</label>
              </div>
              {% endfor %}
            </div>
            <div class="select-actions">
              <button type="button" class="btn-select-all" onclick="selectAll('nameDropdown', 'All Names')">Select All</button>
              <button type="button" class="btn-clear-all" onclick="clearAll('nameDropdown', 'All Names')">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group">
        <label>Client</label>
        <div class="dropdown-multiselect" id="clientDropdown">
          <button type="button" class="dropdown-toggle" onclick="toggleDropdown('clientDropdown')">
            <span class="selected-text">
              {% if client_filter %}{{ client_filter|length }} selected{% else %}All Clients{% endif %}
            </span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="dropdown-menu">
            <div class="dropdown-search">
              <input type="text" placeholder="Search clients..." onkeyup="filterDropdownItems(this, 'clientDropdown')">
            </div>
            <div class="dropdown-items">
              {% for client in all_clients %}
              <div class="dropdown-item">
                <input type="checkbox" id="client_{{ loop.index }}" name="client" value="{{ client }}" {% if client in client_filter %}checked{% endif %} onchange="updateDropdownText('clientDropdown', 'All Clients')">
                <label for="client_{{ loop.index }}">{{ client }}</label>
              </div>
              {% endfor %}
            </div>
            <div class="select-actions">
              <button type="button" class="btn-select-all" onclick="selectAll('clientDropdown', 'All Clients')">Select All</button>
              <button type="button" class="btn-clear-all" onclick="clearAll('clientDropdown', 'All Clients')">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group">
        <label>Engagement</label>
        <div class="dropdown-multiselect" id="engagementDropdown">
          <button type="button" class="dropdown-toggle" onclick="toggleDropdown('engagementDropdown')">
            <span class="selected-text">
              {% if engagement_filter %}{{ engagement_filter|length }} selected{% else %}All Engagements{% endif %}
            </span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="dropdown-menu">
            <div class="dropdown-search">
              <input type="text" placeholder="Search engagements..." onkeyup="filterDropdownItems(this, 'engagementDropdown')">
            </div>
            <div class="dropdown-items">
              {% for eng in all_engagements %}
              <div class="dropdown-item">
                <input type="checkbox" id="eng_{{ loop.index }}" name="engagement" value="{{ eng.id }}" {% if eng.id|string in engagement_filter %}checked{% endif %} onchange="updateDropdownText('engagementDropdown', 'All Engagements')">
                <label for="eng_{{ loop.index }}">{{ eng.name }}</label>
              </div>
              {% endfor %}
            </div>
            <div class="select-actions">
              <button type="button" class="btn-select-all" onclick="selectAll('engagementDropdown', 'All Engagements')">Select All</button>
              <button type="button" class="btn-clear-all" onclick="clearAll('engagementDropdown', 'All Engagements')">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-group">
        <label>Role</label>
        <div class="dropdown-multiselect" id="roleDropdown">
          <button type="button" class="dropdown-toggle" onclick="toggleDropdown('roleDropdown')">
            <span class="selected-text">
              {% if role_filter %}{{ role_filter|length }} selected{% else %}All Roles{% endif %}
            </span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="dropdown-menu">
            <div class="dropdown-search">
              <input type="text" placeholder="Search roles..." onkeyup="filterDropdownItems(this, 'roleDropdown')">
            </div>
            <div class="dropdown-items">
              {% for role in all_roles %}
              <div class="dropdown-item">
                <input type="checkbox" id="role_{{ loop.index }}" name="role" value="{{ role }}" {% if role in role_filter %}checked{% endif %} onchange="updateDropdownText('roleDropdown', 'All Roles')">
                <label for="role_{{ loop.index }}">{{ role }}</label>
              </div>
              {% endfor %}
            </div>
            <div class="select-actions">
              <button type="button" class="btn-select-all" onclick="selectAll('roleDropdown', 'All Roles')">Select All</button>
              <button type="button" class="btn-clear-all" onclick="clearAll('roleDropdown', 'All Roles')">Clear All</button>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-actions">
        <button type="submit" class="filter-btn filter-btn-apply"><i class="fas fa-filter me-1"></i> Apply</button>
        <button type="button" class="filter-btn filter-btn-clear" onclick="clearFilters()"><i class="fas fa-times me-1"></i> Clear</button>
      </div>
    </div>
  </form>
</div>

<!-- Charts Row -->
{% if clients %}
<div class="charts-row">
  <div class="chart-card">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
      <h3 style="margin: 0;"><i class="fas fa-chart-pie"></i> Placements by Client</h3>
      <div style="background: #030a1d; color: white; padding: 0.5rem 1rem; border-radius: 8px; text-align: center;">
        <div style="font-size: 0.65rem; text-transform: uppercase; opacity: 0.9;">Total Placements</div>
        <div style="font-size: 1.5rem; font-weight: 700;">{{ total_placements }}</div>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="clientPieChart"></canvas>
    </div>
  </div>
  <div class="chart-card">
    <h3><i class="fas fa-list"></i> Client Summary</h3>
    <ul class="client-list">
      {% set colors = ['#1e3a8a', '#10b981', '#f59e0b', '#ef4444', '#1e3a8a', '#ec4899', '#1e3a8a', '#84cc16'] %}
      {% for client_name, client_data in clients.items() %}
      <li>
        <div class="client-info">
          <span class="client-color-dot" style="background: {{ colors[loop.index0 % 8] }};"></span>
          {{ client_name }}
        </div>
        <div class="client-metrics">
          <span><strong>{{ client_data.count }}</strong> associate{{ 's' if client_data.count != 1 else '' }}</span>
          <span>£<strong>{{ "{:,.0f}".format(client_data.pay) }}</strong>/day pay</span>
          <span>£<strong>{{ "{:,.0f}".format(client_data.bill) }}</strong>/day bill</span>
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<!-- Placements Table -->
<div class="placements-table-container">
  <div class="placements-table-header">
    <h2>
      <i class="fas fa-clipboard-list"></i>
      On Contract
      <span class="badge">{{ total_placements }}</span>
    </h2>
    <div class="table-actions">
      <input type="text" id="searchInput" placeholder="Search placements..." onkeyup="filterTable()">
    </div>
  </div>
  
  {% if placements %}
  <table class="placements-table" id="placementsTable">
    <thead>
      <tr>
        <th>Associate</th>
        <th>Client</th>
        <th>Engagement</th>
        <th>Role</th>
        <th>Pay Rate</th>
        <th>Bill Rate</th>
        <th>Start Date</th>
        <th>End Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in placements %}
      <tr data-client="{{ p.client }}" data-name="{{ p.associate_name }}" data-engagement="{{ p.engagement_name }}" data-role="{{ p.role }}">
        <td>
          <div class="associate-cell">
            <span class="associate-name">{{ p.associate_name }}</span>
            <span class="associate-email">{{ p.associate_email }}</span>
          </div>
        </td>
        <td class="client-cell">{{ p.client }}</td>
        <td>
          <div class="engagement-cell">
            <span class="engagement-name">{{ p.engagement_name }}</span>
            <span class="engagement-ref">{{ p.engagement_ref }}</span>
          </div>
        </td>
        <td>{{ p.role }}</td>
        <td class="rate-cell">£{{ "{:,.0f}".format(p.pay_rate) }}</td>
        <td class="rate-cell">£{{ "{:,.0f}".format(p.bill_rate) }}</td>
        <td class="date-cell">{{ p.start_date.strftime('%d %b %Y') if p.start_date else '—' }}</td>
        <td class="date-cell">{{ p.end_date.strftime('%d %b %Y') if p.end_date else '—' }}</td>
        <td>
          <div class="d-flex gap-1">
            <a href="{{ url_for('candidate_profile', cand_id=p.associate_id) }}" class="action-btn" title="View Profile">
              <i class="fas fa-user"></i>
            </a>
            <a href="{{ url_for('engagement_dashboard', eng_id=p.engagement_id) }}" class="action-btn" title="View Engagement">
              <i class="fas fa-briefcase"></i>
            </a>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state">
    <i class="fas fa-user-slash"></i>
    <h3>No Active Placements</h3>
    <p>There are currently no associates on contract.</p>
  </div>
  {% endif %}
</div>

<!-- Scheduled Joiners Table (next 14 days) -->
<div class="placements-table-container" style="margin-top: 1.5rem;">
  <div class="placements-table-header">
    <h2>
      <i class="fas fa-user-plus" style="color: #10b981;"></i>
      Scheduled Joiners (Next 14 Days)
      <span class="badge" style="background: #10b981;">{{ scheduled_joiners|length }}</span>
    </h2>
  </div>
  {% if scheduled_joiners %}
  <table class="placements-table">
    <thead>
      <tr>
        <th>Associate</th>
        <th>Role</th>
        <th>Engagement</th>
        <th>Client</th>
        <th>Start Date</th>
        <th>Days Until</th>
      </tr>
    </thead>
    <tbody>
      {% for j in scheduled_joiners %}
      {% set days_until = j.days_until|default(0) %}
      <tr>
        <td>{{ j.candidate.name }}</td>
        <td>{{ j.job.title if j.job else '—' }}</td>
        <td>{{ j.engagement.name if j.engagement else '—' }}</td>
        <td>{{ j.engagement.client if j.engagement else '—' }}</td>
        <td class="date-cell">{{ j.start_date.strftime('%d %b %Y') if j.start_date else '—' }}</td>
        <td>
          {% if days_until <= 0 %}
          <span class="status-badge" style="background: #10b981; color: white;">Today</span>
          {% elif days_until <= 3 %}
          <span class="status-badge" style="background: #f59e0b; color: white;">{{ days_until }} day{{ 's' if days_until != 1 else '' }}</span>
          {% else %}
          <span class="status-badge" style="background: #e8eef8; color: #1e3a8a;">{{ days_until }} days</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state" style="padding: 2rem;">
    <i class="fas fa-user-plus"></i>
    <h4>No Scheduled Joiners</h4>
    <p>No associates are scheduled to start in the next 14 days.</p>
  </div>
  {% endif %}
</div>

<!-- Scheduled Leavers Table (next 30 days) -->
<div class="placements-table-container" style="margin-top: 1.5rem;">
  <div class="placements-table-header">
    <h2>
      <i class="fas fa-user-minus" style="color: #ef4444;"></i>
      Scheduled Leavers (Next 30 Days)
      <span class="badge" style="background: #ef4444;">{{ scheduled_leavers|length }}</span>
    </h2>
  </div>
  {% if scheduled_leavers %}
  <table class="placements-table">
    <thead>
      <tr>
        <th>Associate</th>
        <th>Role</th>
        <th>Engagement</th>
        <th>Client</th>
        <th>Leave Date</th>
        <th>Days Until</th>
      </tr>
    </thead>
    <tbody>
      {% for l in scheduled_leavers %}
      {% set days_until = l.days_until|default(0) %}
      <tr>
        <td>{{ l.candidate.name }}</td>
        <td>{{ l.job.title if l.job else '—' }}</td>
        <td>{{ l.engagement.name if l.engagement else '—' }}</td>
        <td>{{ l.engagement.client if l.engagement else '—' }}</td>
        <td class="date-cell">{{ l.end_date.strftime('%d %b %Y') if l.end_date else '—' }}</td>
        <td>
          {% if days_until <= 0 %}
          <span class="status-badge" style="background: #ef4444; color: white;">Today</span>
          {% elif days_until <= 3 %}
          <span class="status-badge" style="background: #f59e0b; color: white;">{{ days_until }} day{{ 's' if days_until != 1 else '' }}</span>
          {% elif days_until <= 7 %}
          <span class="status-badge" style="background: #fef2f2; color: #ef4444;">{{ days_until }} days</span>
          {% else %}
          <span class="status-badge" style="background: #f3f4f6; color: #6b7280;">{{ days_until }} days</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state" style="padding: 2rem;">
    <i class="fas fa-user-minus"></i>
    <h4>No Scheduled Leavers</h4>
    <p>No associates are scheduled to leave in the next 30 days.</p>
  </div>
  {% endif %}
</div>

<!-- Forecasted Headcount by Engagement - Individual Charts -->
<div class="chart-card" style="margin-top: 1.5rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h3 style="margin: 0;">
      <i class="fas fa-chart-line"></i>
      Forecasted Headcount by Engagement
    </h3>
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-secondary btn-sm forecast-btn active" data-months="1">1M</button>
      <button type="button" class="btn btn-outline-secondary btn-sm forecast-btn" data-months="3">3M</button>
      <button type="button" class="btn btn-outline-secondary btn-sm forecast-btn" data-months="6">6M</button>
      <button type="button" class="btn btn-outline-secondary btn-sm forecast-btn" data-months="12">12M</button>
    </div>
  </div>
  
  <!-- Grid of individual engagement charts -->
  <div id="engagementChartsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
    <!-- Charts will be populated by JavaScript -->
  </div>
  
  {% if not engagement_forecast_data %}
  <div class="empty-state" style="padding: 2rem; text-align: center;">
    <i class="fas fa-chart-line" style="font-size: 2rem; color: #9ca3af;"></i>
    <h4 style="margin-top: 1rem; color: #6b7280;">No Forecast Data</h4>
    <p style="color: #9ca3af;">No signed contracts found to generate forecast.</p>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
// Dropdown Multi-select Functions
function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    document.querySelectorAll('.dropdown-multiselect.open').forEach(d => {
        if (d.id !== dropdownId) d.classList.remove('open');
    });
    dropdown.classList.toggle('open');
}

function updateDropdownText(dropdownId, defaultText) {
    const dropdown = document.getElementById(dropdownId);
    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
    const textSpan = dropdown.querySelector('.selected-text');
    if (checkboxes.length === 0) {
        textSpan.textContent = defaultText;
    } else {
        textSpan.textContent = checkboxes.length + ' selected';
    }
}

function filterDropdownItems(input, dropdownId) {
    const filter = input.value.toLowerCase();
    const dropdown = document.getElementById(dropdownId);
    const items = dropdown.querySelectorAll('.dropdown-item');
    items.forEach(item => {
        const label = item.querySelector('label').textContent.toLowerCase();
        item.style.display = label.includes(filter) ? '' : 'none';
    });
}

function selectAll(dropdownId, placeholder) {
    const dropdown = document.getElementById(dropdownId);
    const checkboxes = dropdown.querySelectorAll('.dropdown-item:not([style*="display: none"]) input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateDropdownText(dropdownId, placeholder);
}

function clearAll(dropdownId, placeholder) {
    const dropdown = document.getElementById(dropdownId);
    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateDropdownText(dropdownId, placeholder);
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown-multiselect')) {
        document.querySelectorAll('.dropdown-multiselect.open').forEach(d => d.classList.remove('open'));
    }
});

function clearFilters() {
    window.location.href = '{{ url_for("placements") }}';
}

// Client data for chart
const clientChartData = [
  {% for client_name, client_data in clients.items() %}
  { name: "{{ client_name }}", count: {{ client_data.count }}, pay: {{ client_data.pay }}, bill: {{ client_data.bill }} }{% if not loop.last %},{% endif %}
  {% endfor %}
];

const chartColors = ['#1e3a8a', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#84cc16'];

// Placements by Client Pie Chart with data labels
const pieCtx = document.getElementById('clientPieChart');
if (pieCtx && clientChartData.length > 0) {
  Chart.register(ChartDataLabels);
  new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: clientChartData.map(c => c.name),
      datasets: [{
        data: clientChartData.map(c => c.count),
        backgroundColor: chartColors.slice(0, clientChartData.length),
        borderColor: '#ffffff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12,
            padding: 10,
            font: { size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${value} placement${value !== 1 ? 's' : ''} (${percentage}%)`;
            }
          }
        },
        datalabels: {
          color: '#fff',
          font: {
            weight: 'bold',
            size: 12
          },
          formatter: function(value) {
            return value > 0 ? value : '';
          },
          anchor: 'center',
          align: 'center'
        }
      }
    }
  });
}

function filterTable() {
  const searchValue = document.getElementById('searchInput')?.value.toLowerCase() || '';
  const rows = document.querySelectorAll('#placementsTable tbody tr');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchValue) ? '' : 'none';
  });
}

function exportToCSV() {
  const table = document.getElementById('placementsTable');
  if (!table) return;
  
  let csv = [];
  const rows = table.querySelectorAll('tr');
  
  rows.forEach(row => {
    const cols = row.querySelectorAll('td, th');
    const rowData = [];
    cols.forEach((col, index) => {
      if (index < cols.length - 1) {
        let text = col.innerText.replace(/,/g, '').replace(/\n/g, ' ').trim();
        rowData.push('"' + text + '"');
      }
    });
    csv.push(rowData.join(','));
  });
  
  const csvContent = csv.join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'placements_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  window.URL.revokeObjectURL(url);
}

// Forecasted Headcount - Individual Charts per Engagement
const engagementForecastData = [
  {% for e in engagement_forecast_data %}
  {
    id: {{ e.id }},
    name: "{{ e.name }}",
    client: "{{ e.client }}",
    startDate: "{{ e.start_date or '' }}",
    endDate: "{{ e.end_date or '' }}",
    headcount: {{ e.headcount }},
    currentHeadcount: {{ e.current_headcount }},
    placements: [
      {% for p in e.placements %}
      {
        name: "{{ p.name }}",
        startDate: {% if p.start_date %}"{{ p.start_date }}"{% else %}null{% endif %},
        endDate: {% if p.end_date %}"{{ p.end_date }}"{% else %}null{% endif %}
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  }{% if not loop.last %},{% endif %}
  {% endfor %}
];

// Color palette for engagement charts
const engagementColors = [
  '#1e3a8a', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
  '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
];

// Store chart instances for cleanup
let engagementCharts = {};

function generateWeeklyLabels(months) {
  const today = new Date();
  const weeks = months * 4;
  const labels = [];
  
  for (let i = 0; i <= weeks; i++) {
    const weekDate = new Date(today);
    weekDate.setDate(today.getDate() + (i * 7));
    labels.push(weekDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
  }
  
  return labels;
}

function generateEngagementData(eng, months) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const weeks = months * 4;
  const data = [];
  
  for (let i = 0; i <= weeks; i++) {
    const weekDate = new Date(today);
    weekDate.setDate(today.getDate() + (i * 7));
    weekDate.setHours(0, 0, 0, 0);
    
    // Count active placements for this specific week date
    // This uses the individual placement start/end dates (joiners/leavers)
    let weekHeadcount = 0;
    
    eng.placements.forEach(p => {
      const pStart = p.startDate ? new Date(p.startDate) : null;
      const pEnd = p.endDate ? new Date(p.endDate) : null;
      
      // Placement has started (no start date = already started)
      const hasStarted = !pStart || weekDate >= pStart;
      // Placement has ended (only if end date exists and weekDate is past it)
      const hasEnded = pEnd && weekDate > pEnd;
      
      if (hasStarted && !hasEnded) {
        weekHeadcount++;
      }
    });
    
    data.push(weekHeadcount);
  }
  
  return data;
}

function getEngagementStatus(eng) {
  const today = new Date();
  const startDate = eng.startDate ? new Date(eng.startDate) : null;
  const endDate = eng.endDate ? new Date(eng.endDate) : null;
  
  if (startDate && startDate > today) {
    const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
    return { text: `Starting in ${daysUntil} days`, color: '#10b981', icon: 'fa-arrow-up' };
  } else if (endDate) {
    const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
    if (daysUntil <= 0) {
      return { text: 'Ended', color: '#6b7280', icon: 'fa-check' };
    } else if (daysUntil <= 14) {
      return { text: `Ending in ${daysUntil} days`, color: '#ef4444', icon: 'fa-arrow-down' };
    } else {
      return { text: 'Active', color: '#1e3a8a', icon: 'fa-circle' };
    }
  }
  return { text: 'Active', color: '#1e3a8a', icon: 'fa-circle' };
}

function renderEngagementCharts(months) {
  const container = document.getElementById('engagementChartsGrid');
  if (!container || engagementForecastData.length === 0) return;
  
  // Clear existing charts
  Object.values(engagementCharts).forEach(chart => chart.destroy());
  engagementCharts = {};
  
  // Clear container
  container.innerHTML = '';
  
  // Generate common labels
  const labels = generateWeeklyLabels(months);
  
  // Create a card with chart for each engagement
  engagementForecastData.forEach((eng, index) => {
    const color = engagementColors[index % engagementColors.length];
    const status = getEngagementStatus(eng);
    const data = generateEngagementData(eng, months);
    
    // Create card element
    const card = document.createElement('div');
    card.className = 'engagement-forecast-card';
    card.style.cssText = `
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    `;
    
    card.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
        <div>
          <h4 style="margin: 0; font-size: 0.95rem; font-weight: 600; color: #1f2937;">${eng.name}</h4>
          <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: #6b7280;">${eng.client || 'No client'}</p>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 1.5rem; font-weight: 700; color: ${color};">${eng.headcount}</div>
          <div style="font-size: 0.7rem; color: #6b7280;">placed</div>
        </div>
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
        <i class="fas ${status.icon}" style="color: ${status.color}; font-size: 0.7rem;"></i>
        <span style="font-size: 0.75rem; color: ${status.color}; font-weight: 500;">${status.text}</span>
      </div>
      <div style="position: relative; height: 120px;">
        <canvas id="engChart_${eng.id}"></canvas>
      </div>
    `;
    
    container.appendChild(card);
    
    // Create chart
    const ctx = document.getElementById(`engChart_${eng.id}`);
    if (ctx) {
      engagementCharts[eng.id] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            borderColor: color,
            backgroundColor: color + '20',
            fill: true,
            tension: 0.3,
            pointRadius: 2,
            pointHoverRadius: 4,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                title: (items) => items[0].label,
                label: (context) => `${context.parsed.y} people`
              }
            }
          },
          scales: {
            x: {
              display: true,
              grid: { display: false },
              ticks: {
                font: { size: 9 },
                color: '#9ca3af',
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 6
              }
            },
            y: {
              display: true,
              grid: { color: '#f3f4f6' },
              beginAtZero: true,
              max: Math.max(...data) + 1,
              ticks: {
                font: { size: 9 },
                color: '#9ca3af',
                stepSize: 1,
                maxTicksLimit: 4
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }
  });
}

// Initialize charts with 1 month view
renderEngagementCharts(1);

// Handle forecast period buttons
document.querySelectorAll('.forecast-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.forecast-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    renderEngagementCharts(parseInt(this.dataset.months));
  });
});
</script>
{% endblock %}
